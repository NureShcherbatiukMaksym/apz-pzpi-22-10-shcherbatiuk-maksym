{"ast":null,"code":"// utils/api.js\nimport axios from 'axios';\nconst api = axios.create({\n  baseURL: 'http://localhost:5000/api',\n  // або твій домен\n  withCredentials: true // якщо токени/сесія у cookie\n});\nlet onUnauthorizedCallback = null;\n// Add a flag to prevent multiple logout attempts from the interceptor\nlet isLoggingOut = false;\nexport const setUnauthorizedCallback = callback => {\n  onUnauthorizedCallback = callback;\n};\n\n// Function for UserContext to set the logging out status\nexport const setIsLoggingOut = status => {\n  isLoggingOut = status;\n  console.log('API Interceptor: isLoggingOut set to', isLoggingOut);\n};\n\n// Додаємо інтерцептор для відповідей\napi.interceptors.response.use(response => response, async error => {\n  var _error$response, _error$response2;\n  // Check if error is 401 and we are NOT already in the process of logging out\n  if (((_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.status) === 401 && !isLoggingOut) {\n    console.error('API Interceptor: Received 401 Unauthorized. Initiating logout.');\n    // Set the flag immediately\n    setIsLoggingOut(true); // Use the exported function\n\n    // Call the logout callback if set\n    if (onUnauthorizedCallback) {\n      try {\n        await onUnauthorizedCallback();\n      } catch (logoutErr) {\n        console.error('API Interceptor: Error during unauthorized callback execution:', logoutErr);\n        // Continue rejecting the original error\n      } finally {\n        // The callback (logoutUser) should ideally reset isLoggingOut=false\n        // but doing it here is safer if the callback fails unexpectedly before resetting.\n        // However, the context should manage resetting it after state/LS clear.\n      }\n    } else {\n      console.warn('API Interceptor: 401 received, but no unauthorized callback is set.');\n      // If no callback is set, we can't log out properly, just log the error.\n      // Reset the flag if no callback to prevent it staying true indefinitely\n      setIsLoggingOut(false);\n    }\n  } else if (((_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : _error$response2.status) === 401 && isLoggingOut) {\n    console.log('API Interceptor: Received 401 while already logging out. Ignoring.');\n    // Ignore 401s that happen while we are already logging out\n  }\n\n  // Always reject the original promise so the component knows the call failed\n  return Promise.reject(error);\n});\nexport default api;","map":{"version":3,"names":["axios","api","create","baseURL","withCredentials","onUnauthorizedCallback","isLoggingOut","setUnauthorizedCallback","callback","setIsLoggingOut","status","console","log","interceptors","response","use","error","_error$response","_error$response2","logoutErr","warn","Promise","reject"],"sources":["D:/Program Files/WebstormProjects/soil_scout/web/src/utils/api.js"],"sourcesContent":["// utils/api.js\r\nimport axios from 'axios';\r\n\r\nconst api = axios.create({\r\n    baseURL: 'http://localhost:5000/api', // або твій домен\r\n    withCredentials: true, // якщо токени/сесія у cookie\r\n});\r\n\r\nlet onUnauthorizedCallback = null;\r\n// Add a flag to prevent multiple logout attempts from the interceptor\r\nlet isLoggingOut = false;\r\n\r\nexport const setUnauthorizedCallback = (callback) => {\r\n    onUnauthorizedCallback = callback;\r\n};\r\n\r\n// Function for UserContext to set the logging out status\r\nexport const setIsLoggingOut = (status) => {\r\n    isLoggingOut = status;\r\n    console.log('API Interceptor: isLoggingOut set to', isLoggingOut);\r\n};\r\n\r\n\r\n// Додаємо інтерцептор для відповідей\r\napi.interceptors.response.use(\r\n    response => response,\r\n    async error => {\r\n        // Check if error is 401 and we are NOT already in the process of logging out\r\n        if (error.response?.status === 401 && !isLoggingOut) {\r\n            console.error('API Interceptor: Received 401 Unauthorized. Initiating logout.');\r\n            // Set the flag immediately\r\n            setIsLoggingOut(true); // Use the exported function\r\n\r\n            // Call the logout callback if set\r\n            if (onUnauthorizedCallback) {\r\n                try {\r\n                    await onUnauthorizedCallback();\r\n                } catch (logoutErr) {\r\n                    console.error('API Interceptor: Error during unauthorized callback execution:', logoutErr);\r\n                    // Continue rejecting the original error\r\n                } finally {\r\n                    // The callback (logoutUser) should ideally reset isLoggingOut=false\r\n                    // but doing it here is safer if the callback fails unexpectedly before resetting.\r\n                    // However, the context should manage resetting it after state/LS clear.\r\n                }\r\n            } else {\r\n                console.warn('API Interceptor: 401 received, but no unauthorized callback is set.');\r\n                // If no callback is set, we can't log out properly, just log the error.\r\n                // Reset the flag if no callback to prevent it staying true indefinitely\r\n                setIsLoggingOut(false);\r\n            }\r\n        } else if (error.response?.status === 401 && isLoggingOut) {\r\n            console.log('API Interceptor: Received 401 while already logging out. Ignoring.');\r\n            // Ignore 401s that happen while we are already logging out\r\n        }\r\n\r\n        // Always reject the original promise so the component knows the call failed\r\n        return Promise.reject(error);\r\n    }\r\n);\r\n\r\nexport default api;"],"mappings":"AAAA;AACA,OAAOA,KAAK,MAAM,OAAO;AAEzB,MAAMC,GAAG,GAAGD,KAAK,CAACE,MAAM,CAAC;EACrBC,OAAO,EAAE,2BAA2B;EAAE;EACtCC,eAAe,EAAE,IAAI,CAAE;AAC3B,CAAC,CAAC;AAEF,IAAIC,sBAAsB,GAAG,IAAI;AACjC;AACA,IAAIC,YAAY,GAAG,KAAK;AAExB,OAAO,MAAMC,uBAAuB,GAAIC,QAAQ,IAAK;EACjDH,sBAAsB,GAAGG,QAAQ;AACrC,CAAC;;AAED;AACA,OAAO,MAAMC,eAAe,GAAIC,MAAM,IAAK;EACvCJ,YAAY,GAAGI,MAAM;EACrBC,OAAO,CAACC,GAAG,CAAC,sCAAsC,EAAEN,YAAY,CAAC;AACrE,CAAC;;AAGD;AACAL,GAAG,CAACY,YAAY,CAACC,QAAQ,CAACC,GAAG,CACzBD,QAAQ,IAAIA,QAAQ,EACpB,MAAME,KAAK,IAAI;EAAA,IAAAC,eAAA,EAAAC,gBAAA;EACX;EACA,IAAI,EAAAD,eAAA,GAAAD,KAAK,CAACF,QAAQ,cAAAG,eAAA,uBAAdA,eAAA,CAAgBP,MAAM,MAAK,GAAG,IAAI,CAACJ,YAAY,EAAE;IACjDK,OAAO,CAACK,KAAK,CAAC,gEAAgE,CAAC;IAC/E;IACAP,eAAe,CAAC,IAAI,CAAC,CAAC,CAAC;;IAEvB;IACA,IAAIJ,sBAAsB,EAAE;MACxB,IAAI;QACA,MAAMA,sBAAsB,CAAC,CAAC;MAClC,CAAC,CAAC,OAAOc,SAAS,EAAE;QAChBR,OAAO,CAACK,KAAK,CAAC,gEAAgE,EAAEG,SAAS,CAAC;QAC1F;MACJ,CAAC,SAAS;QACN;QACA;QACA;MAAA;IAER,CAAC,MAAM;MACHR,OAAO,CAACS,IAAI,CAAC,qEAAqE,CAAC;MACnF;MACA;MACAX,eAAe,CAAC,KAAK,CAAC;IAC1B;EACJ,CAAC,MAAM,IAAI,EAAAS,gBAAA,GAAAF,KAAK,CAACF,QAAQ,cAAAI,gBAAA,uBAAdA,gBAAA,CAAgBR,MAAM,MAAK,GAAG,IAAIJ,YAAY,EAAE;IACvDK,OAAO,CAACC,GAAG,CAAC,oEAAoE,CAAC;IACjF;EACJ;;EAEA;EACA,OAAOS,OAAO,CAACC,MAAM,CAACN,KAAK,CAAC;AAChC,CACJ,CAAC;AAED,eAAef,GAAG","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}